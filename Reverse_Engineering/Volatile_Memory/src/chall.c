#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <unistd.h>

unsigned char encrypted_code[] = {
    0xff, 0xe2, 0x23, 0x4f, 0xe2, 0x23, 0xd7, 0x52, 0xe2, 0x21, 0xef, 0x52, 0xa5, 0x1c, 0xaa, 0x96, 0xe6, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0xaa, 0xa8, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xab, 0xa5, 0x1c, 0xaa, 0x96, 0xe1, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x4d, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa8, 0xa5, 0x1c, 0xaa, 0x96, 0xf9, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x64, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa9, 0xa5, 0x1c, 0xaa, 0x96, 0xd1, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x1f, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xae, 0xa5, 0x1c, 0xaa, 0x96, 0xc2, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x36, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xaf, 0xa5, 0x1c, 0xaa, 0x96, 0x9b, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x29, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xac, 0xa5, 0x1c, 0xaa, 0x96, 0xce, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0xc0, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xad, 0xa5, 0x1c, 0xaa, 0x96, 0xce, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0xfb, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa2, 0xa5, 0x1c, 0xaa, 0x96, 0x99, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x92, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa3, 0xa5, 0x1c, 0xaa, 0x96, 0xc4, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0xb5, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa0, 0xa5, 0x1c, 0xaa, 0x96, 0xf5, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0xac, 0xab, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa1, 0xa5, 0x1c, 0xaa, 0x96, 0x9b, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x47, 0xaa, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa6, 0xa5, 0x1c, 0xaa, 0x96, 0xc4, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x7e, 0xaa, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa7, 0xa5, 0x1c, 0xaa, 0x96, 0xf5, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x11, 0xaa, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa4, 0xa5, 0x1c, 0xaa, 0x96, 0xd8, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x08, 0xaa, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xa5, 0xa5, 0x1c, 0xaa, 0x96, 0x9e, 0xde, 0xa0, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x43, 0x23, 0xaa, 0xaa, 0xaa, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xba, 0xa5, 0x1c, 0xaa, 0x96, 0xc7, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0xd9, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xbb, 0xa5, 0x1c, 0xaa, 0x96, 0xf5, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0xf7, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xb8, 0xa5, 0x1c, 0xaa, 0x96, 0x9c, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0xed, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xb9, 0xa5, 0x1c, 0xaa, 0x96, 0x9d, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0x9b, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xbe, 0xa5, 0x1c, 0xaa, 0x96, 0xd7, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0xb1, 0xe2, 0x21, 0xef, 0x52, 0xe2, 0x29, 0x6a, 0xbf, 0xa5, 0x1c, 0xaa, 0x2e, 0x6a, 0xde, 0xad, 0x12, 0xaa, 0xaa, 0xaa, 0xaa, 0x41, 0xaf, 0x12, 0xab, 0xaa, 0xaa, 0xaa, 0xf7, 0x69
};

int main(int argc, char *argv[]){
    if (argc < 2){
        printf("Gunakan: %s <flag>\n", argv[0]);
        return 1;
    }
    
    size_t code_len = sizeof(encrypted_code);

    void *mem = mmap(NULL, code_len, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    if (mem == MAP_FAILED) {
        perror("Gagal alokasi memory");
        return 1;
    } 

    memcpy(mem, encrypted_code, code_len);

    unsigned char *p = (unsigned char *)mem;
    for (int i = 0; i < code_len; i++){
        p[i] ^= 0xAA;
    }

    if (mprotect(mem, code_len, PROT_READ | PROT_EXEC) == -1){
        perror("gagal mprotect");
        return 1;
    }

    int (*check_func)(char  *) = (int (*)(char *))mem;

    printf("Memeriksa flag...\n");

    int result = check_func(argv[1]);

    if (result == 1){
        printf("Correct!\n");
    } else {
        printf("Wrong!\n");
    }

    munmap(mem, code_len);
    return 0;
}
